<!DOCTYPE html>
<html data-bs-theme="light">
<!-- <html data-bs-theme="dark"> -->

<head>
    <meta charset="UTF-8" />
    <!--适配手机-->
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>后台管理</title>
    <link rel="stylesheet" href="./assets/css/toastui-editor.min.css" />
    <link rel="stylesheet" href="./assets/css/toastui-editor-dark.css" />
    <link rel="stylesheet" href="./assets/css/prism.min.css" />
    <link rel="stylesheet" href="./assets/css/toastui-editor-plugin-code-syntax-highlight.min.css" />
    <link rel="stylesheet" href="./assets/css/tui-color-picker.min.css" />
    <link rel="stylesheet" href="./assets/css/toastui-editor-plugin-color-syntax.min.css" />
    <link rel="stylesheet" href="./assets/css/bootstrap.min.css">
    <style>
        html,
        body {
            padding: 0.3rem;
            width: 100%;
            height: 100%;
            overflow: hidden;
        }

        .fade:not(.show) {
            display: none !important;
        }

        .modal-footer {
            border-top: none;
        }



        .toastui-editor-dropdown-toolbar {
            width: 100% !important;
            overflow-y: hidden !important;
            height: 55px !important;
            right: 0px !important;
        }

        .toastui-editor-defaultUI {
            border: 1px solid var(--bs-border-color) !important;
        }

        .toastui-editor-mode-switch {
            background-color: var(--bs-tertiary-bg) !important;
            border-top: 1px solid var(--bs-border-color) !important;
        }



        .form-check-input,
        .form-check-label {
            cursor: pointer;
        }

        #file-box2 {
            border: 2px dashed #efefef;
        }

        #file-box2:hover {
            border: 2px dashed #0097dfcc;
            background-color: #67ccff1f;
        }

        #img_list_box {
            height: 50px;
            overflow-y: hidden;
        }

        #img_list_box::-webkit-scrollbar,
        #recent_img_list_box::-webkit-scrollbar {
            height: 8px;
        }

        #img_list_box::-webkit-scrollbar-thumb,
        #recent_img_list_box::-webkit-scrollbar-thumb {
            border-radius: 10px;
            background-color: #6e6e6e73;
        }

        .zoomed {
            z-index: 987 !important;
            width: 100% !important;
            height: 100% !important;
            position: fixed !important;
            top: 0 !important;
            left: 0 !important;
            padding: 1% !important;
        }

        .loader {
            width: 50px;
            aspect-ratio: 1;
            display: grid;
            border: 4px solid #0000;
            border-radius: 50%;
            border-right-color: #25b09b;
            animation: l15 1s infinite linear;
            margin: 10% auto;
        }

        .loader::before,
        .loader::after {
            content: "";
            grid-area: 1/1;
            margin: 2px;
            border: inherit;
            border-radius: 50%;
            animation: l15 2s infinite;
        }

        .loader::after {
            margin: 8px;
            animation-duration: 3s;
        }

        @keyframes l15 {
            100% {
                transform: rotate(1turn)
            }
        }

        .AB,
        .f_btn {
            /* visibility: hidden; */
            opacity: 0;
        }

        .AB:hover,
        .f_btn:hover {
            /* visibility: visible; */
            opacity: 1;
        }

        #tc_content_box,
        .scrollbar-box {
            overflow-y: auto;
            height: 500px;
        }

        #tc_content_box::-webkit-scrollbar,
        .scrollbar-box::-webkit-scrollbar,
        #tuchuang_box::-webkit-scrollbar,
        #home_content::-webkit-scrollbar {
            width: 8px;

        }

        #tc_content_box::-webkit-scrollbar-thumb,
        .scrollbar-box::-webkit-scrollbar-thumb,
        #tuchuang_box::-webkit-scrollbar,
        #home_content::-webkit-scrollbar {
            border-radius: 10px;
            background-color: #ced4da6e;
        }

        #recent_img_list_box {
            background-color: rgba(0, 0, 0, 0.082);
        }

        .post_item {
            transition: all 0.3s;
        }

        .post_item:hover {
            transform: scale(1.02);
            margin: 0;
            border: var(--bs-tertiary-bg) !important;
        }

        .edit_btn {
            transition: all 0.3s;
        }

        .edit_btn:hover {
            transform: scale(1.1);
        }




        /* 定义关键帧动画 */
        @keyframes breathingEffect {

            0%,
            100% {
                opacity: 1;
            }

            50% {
                opacity: 0.3;
            }
        }

        .breathing {
            animation: breathingEffect 1.5s ease-in-out infinite;
            will-change: opacity;
        }

        .accordion-button:not(.collapsed) {
            background-color: #00000000 !important;
        }
    </style>
</head>

<body class="d-flex flex-column align-items-center ">
    <script src="./assets/js/toastui-editor-all.min.js"></script>
    <script src="./assets/js/zh-cn.js"></script>
    <script src="./assets/js/toastui-editor-plugin-code-syntax-highlight-all.min.js"></script>
    <script src="./assets/js/tui-color-picker.min.js"></script>
    <script src="./assets/js/toastui-editor-plugin-color-syntax.min.js"></script>
    <script src="./assets/js/bootstrap.bundle.min.js"></script>

    <!-- 提示框 -->
    <div id="liveAlertPlaceholder" class="show position-absolute start-0 w-100 p-2" style="z-index: 999;"></div>



    <!-- 界面 -->
    <div class="w-100 h-100 p-3 m-0 d-flex ">

        <!-- 左侧 -->
        <div class="border rounded me-2 w-25 p-2 flex-column align-items-center overflow-auto"
            style="display: none;overflow-x: hidden !important;" id="tuchuang_box">
            <div id="recent_img_list_box" class="rounded d-flex w-100 p-1 m-1 overflow-x-auto"></div>
            <div class="w-100 flex-fill mb-2 d-flex flex-column align-items-center justify-content-center">
                <div class="w-100">
                    <button type="button" class="btn btn-primary" id="update_img">刷新</button>
                </div>
                <div class="accordion accordion-flush flex-fill w-100" id="tc_content_box"></div>
            </div>
            <div class="w-100 d-flex flex-column align-items-center justify-content-center" style="height: 20%;">
                <div class="w-100 m-1 p-2 rounded" id="preview_box"
                    style="display: flex;background: rgba(0, 0, 0, 0.082);">
                    <div class="d-flex flex-fill" id="img_list_box"></div>
                    <button type="button"
                        class="btn btn-primary ms-2 d-flex align-items-center justify-content-center h-100"
                        style="width: 50px;" id="uploadimg"><span style="font-size: 0.6rem;">上传</span></button>
                </div>
                <div class="rounded w-100 flex-fill d-flex flex-column align-items-center justify-content-center position-relative"
                    id="file-box2">
                    <span class="w-100 position-absolute text-center">拖拽图片到此或者点击上传</span>
                    <input type="file" id="image_input" onchange="toBase64()"
                        accept="image/jpeg,image/png,image/jpg,image/gif" multiple style="cursor: pointer;"
                        class="opacity-0 w-100 h-100" />

                </div>
            </div>
        </div>

        <!-- 右侧 -->
        <div class="w-100 h-100 p-3 m-0 d-flex flex-column border rounded">
            <!-- Nav tabs -->
            <ul class="nav nav-tabs" id="myTabs" role="tablist">
                <li class="nav-item " role="presentation">
                    <button class="nav-link active" id="home-tab" data-bs-toggle="tab" data-bs-target="#_home"
                        type="button" role="tab" aria-controls="_home" aria-selected="true">🏠️主页</button>
                </li>
                <li class="nav-item" role="presentation">
                    <button class="nav-link" id="w_blog-tab" data-bs-toggle="tab" data-bs-target="#w_blog" type="button"
                        role="tab" aria-controls="w_blog" aria-selected="true">📝写文章</button>
                </li>
                <li class="nav-item" role="presentation">
                    <button class="nav-link" id="settings-tab" data-bs-toggle="tab" data-bs-target="#_settings"
                        type="button" role="tab" aria-controls="_settings" aria-selected="false">⚙️设置</button>
                </li>
                <li class="nav-item d-flex align-items-center justify-content-center" role="presentation">
                    <div class="form-check form-switch m-0 ms-3">
                        <input class="form-check-input" type="checkbox" role="switch" id="tuchuang">
                        <label class="form-check-label" for="tuchuang">🖼️图床</label>
                    </div>
                </li>
            </ul>

            <!-- Tab panes -->
            <div class="tab-content flex-fill d-flex flex-column position-relative">
                <div class="tab-pane fade show active  position-absolute w-100 h-100 d-flex flex-column align-items-center justify-content-center"
                    id="_home" role="tabpanel" aria-labelledby="home-tab">
                    <div style="position: fixed;left: 0;top: 0;width: 100%;height: 100%;display: none;flex-direction: column;align-items: center;justify-content: center;background: #0000005e;z-index: 666;transition: all 1s;opacity:0;"
                        id="del_msbox">
                        <div id="del_msbox2"
                            style="width: 100%;height: 100%;display: flex;flex-direction: column;justify-content: center;align-items: center;position: fixed;bottom: 100%;left: 0;transition: all 0.6s ease 0s;">
                            <div
                                style="background: var(--bs-tertiary-bg);padding: 30px 30px 10px 30px;border-radius: 5px;width: 250px;display: flex;flex-direction: column;align-items: center;justify-content: center;">
                                (ὸ⍸ό)✧ 是否删除文章？
                                <div style="margin-top: 25px;">
                                    <button type="button" class="btn btn-secondary m-2" id="c_del">取消</button>
                                    <button type="button" class="btn btn-danger m-2" id="e_del">删除</button>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="flex-column align-items-center justify-content-center " id="no_set"
                        style="display: none;">
                        <p id="ptext"></p>
                        <button type="button" class="btn btn-outline-primary" id="set_info">设置</button>
                    </div>
                    <div class="w-100 h-100 flex-column" id="post_box" style="display: none;">
                        <button type="button" id="load_post" class="btn btn-primary m-2">
                            加载文章
                        </button>
                        <div class="flex-fill overflow-y-auto overflow-x-hidden" id="home_content">
                        </div>
                        <span id="postlist_changedate"
                            style="font-size: 0.5rem;width: 100%;text-align: right;position: fixed;right: 25px;bottom: 5px;"></span>
                    </div>
                </div>

                <div class="tab-pane fade flex-fill d-flex position-absolute w-100 h-100" id="w_blog" role="tabpanel"
                    aria-labelledby="w_blog-tab">

                    <div class=" d-flex flex-column w-100 h-100 flex-fill">
                        <div id="title_box" class="d-flex flex-column mb-2">
                            <div class="accordion accordion-flush" id="wenzhang0">
                                <div class="accordion-item">
                                    <div class="accordion-header" id="wenzhang1">
                                        <button class="accordion-button collapsed p-2 rounded" type="button"
                                            data-bs-toggle="collapse" data-bs-target="#wenzhang2" aria-expanded="false"
                                            aria-controls="wenzhang2">
                                            文章设置
                                        </button>
                                    </div>
                                    <div id="wenzhang2" class="accordion-collapse collapse" aria-labelledby="wenzhang1"
                                        data-bs-parent="#wenzhang0">
                                        <div class="accordion-body">
                                            <div class="mb-2 mt-2">
                                                <input type="text" class="form-control" id="post_title"
                                                    placeholder="文章标题">
                                            </div>
                                            <div class="mb-2">
                                                <textarea class="form-control" id="post_description"
                                                    placeholder="文章描述。为空时会自动摘取文章开头内容" rows="3"></textarea>
                                            </div>
                                            <div class="input-group mb-2">
                                                <input type="text" class="form-control" id="post_categories"
                                                    placeholder="分类 最多2个，逗号分隔">
                                                <span class="input-group-text"></span>
                                                <input type="text" class="form-control" id="post_tag"
                                                    placeholder="标签 支持多个，逗号分隔">
                                            </div>
                                            <div class="input-group mb-2">
                                                <input type="text" class="form-control" id="post_img"
                                                    placeholder="封面图链接">
                                                <span class="input-group-text"></span>
                                                <input type="text" class="form-control" id="post_img_alt"
                                                    placeholder="封面描述">
                                            </div>

                                            <div class="d-flex justify-content-end">
                                                <div class="form-check form-switch me-2">
                                                    <input class="form-check-input" type="checkbox" role="switch"
                                                        id="zhiding">
                                                    <label class="form-check-label" for="zhiding">置顶文章</label>
                                                </div>
                                                <div class="form-check form-switch me-2">
                                                    <input class="form-check-input" type="checkbox" role="switch"
                                                        id="shuxue">
                                                    <label class="form-check-label" for="shuxue">数学函数</label>
                                                </div>
                                                <div class="form-check form-switch me-2">
                                                    <input class="form-check-input" type="checkbox" role="switch"
                                                        id="tubiao">
                                                    <label class="form-check-label" for="tubiao">渲染图表</label>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>

                        </div>
                        <div id="editor" class="flex-fill"></div>
                        <div class="d-flex justify-content-center">
                            <div style="position: fixed;left: 0;top: 0;width: 100%;height: 100%;display: none;flex-direction: column;align-items: center;justify-content: center;background: #0000005e;z-index: 666;transition: all 1s;opacity:0;"
                                id="post_msbox">
                                <div id="post_msbox2"
                                    style="width: 100%;height: 100%;display: flex;flex-direction: column;justify-content: center;align-items: center;position: fixed;bottom: 100%;left: 0;transition: all 0.6s ease 0s;">
                                    <div
                                        style="background: var(--bs-tertiary-bg);padding: 30px 30px 10px 30px;border-radius: 5px;width: 250px;display: flex;flex-direction: column;align-items: center;justify-content: center;">
                                        ƪ(•̃͡•̃͡ ƪ 是否发布文章？
                                        <div style="margin-top: 25px;">
                                            <button type="button" class="btn btn-secondary m-2" id="c_post">取消</button>
                                            <button type="button" class="btn btn-primary m-2" id="e_post">发布</button>
                                        </div>
                                    </div>
                                </div>

                            </div>

                            <button type="button" class="btn btn-success w-25 m-4" id="_post">发布文章</button>
                            <button type="button" class="btn btn-primary w-25 m-4" id="_post2"
                                style="display: none;">发布修改文章</button>
                        </div>
                    </div>

                </div>

                <div class="tab-pane fade flex-fill position-absolute w-100 h-100 d-flex flex-column align-items-center justify-content-center"
                    id="_settings" role="tabpanel" aria-labelledby="settings-tab">
                    <div class="border rounded p-5 d-flex flex-column align-items-center justify-content-center">
                        <span class="mb-2">基础设置</span>
                        <div class="input-group mb-3">
                            <span class="input-group-text">https://github.com/</span>
                            <input type="text" class="form-control" id="owner_" placeholder="拥有者"
                                aria-label="ownername">
                            <span class="input-group-text">/</span>
                            <input type="text" class="form-control" id="repo_" placeholder="仓库名" aria-label="reponame">
                        </div>
                        <div class="input-group mb-3">
                            <span class="input-group-text">提交者</span>
                            <input type="text" class="form-control" id="name_" placeholder="github账户的name"
                                aria-label="name">
                            <span class="input-group-text">邮箱</span>
                            <input type="text" class="form-control" id="email_" placeholder="github账户的email"
                                aria-label="email">
                        </div>
                        <div class="input-group mb-2">
                            <span class="input-group-text">Access_Token</span>
                            <input type="password" class="form-control" id="accessTokenInput" placeholder="token"
                                aria-label="atoken">
                            <button type="button" class="btn btn-outline-primary" id="show_hide">显示</button>
                        </div class="mb-3">
                        <div class="mb-3" style="width: 100%;text-align: center;" id="sulv"></div>
                        <div class="input-group mb-4">
                            <span class="input-group-text">github图床CDN加速</span>
                            <input type="text" class="form-control" placeholder="https://raw.githubusercontent.com"
                                aria-label="imgpath" id="img_cdn">
                            <span class="input-group-text">/</span>
                        </div>

                        <span class="mb-2">github图床设置</span>
                        <div class="input-group mb-4">
                            <span class="input-group-text" id="img_set_box_text"></span>
                            <input type="text" class="form-control" placeholder="图片文件夹路径" aria-label="imgpath"
                                id="img_set_box_">
                            <span class="input-group-text">/</span>
                        </div>

                        <button class="btn btn-primary w-25" type="submit" id="save_info">保存</button>
                    </div>

                </div>
            </div>
        </div>
    </div>



    <span style="font-size: 0.5rem;width: 100%;text-align: center;position: fixed;right: 25px;bottom: 5px;">
        Copyright © by <a href="https://binfen23.github.io" style="text-decoration: none;" target="_blank">Zeb</a> |
        Powered by <a href="https://github.com/binfen23/bfmanage" style="text-decoration: none;"
            target="_blank">bfmanage</a>
    </span>
</body>




<script>

    var owner = "";
    var repo = "";
    var img_path = "";
    var atoken = "";
    var name_ = "";
    var email_ = "";
    var imgcdn = "";


    function ready(callbackFunction) {
        if (document.readyState !== 'loading') {
            callbackFunction();
        } else {
            document.addEventListener('DOMContentLoaded', callbackFunction);
        }
    }
    var cfg_data = "还未正确设置配置";
    //读取配置
    function get_config() {
        if (localStorage.getItem('config') == null) {
            let configs = {
                "zt": "light",
                "zdbc": false,
                "tcan": false,
                "sz": {
                    "yyz": "",
                    "cangku": "",
                    "token": "",
                    "img_cdn": "",
                    "lujing": "",
                    "tjz": "",
                    "email": ""
                }
            }
            localStorage.setItem('config', JSON.stringify(configs));
            cfg_data = configs
        } else {
            let config = JSON.parse(localStorage.getItem('config'));
            cfg_data = config
        }

        return cfg_data
    }

    //设置配置
    function set_config(cfgs) {
        localStorage.setItem('config', JSON.stringify(cfgs));
    }

    //更新配置状态
    function change_ui(cfgs) {
        document.getElementById("tuchuang").checked = cfgs.tcan;
        document.getElementById("auto_save").checked = cfgs.zdbc;
        document.getElementById("owner_").value = cfgs.sz.yyz;
        document.getElementById("repo_").value = cfgs.sz.cangku;
        document.getElementById("name_").value = cfgs.sz.tjz;
        document.getElementById("email_").value = cfgs.sz.email;
        document.getElementById("accessTokenInput").value = cfgs.sz.token;
        document.getElementById("img_cdn").value = cfgs.sz.img_cdn;
        document.getElementById("img_set_box_").value = cfgs.sz.lujing;
    }
    function change_post() {
        if (localStorage.getItem('post_data') == null) {
            let post_data = {
                "pt": "",
                "pd": "",
                "pc": "",
                "ptag": "",
                "pi": "",
                "pia": "",
                "pz": "",
                "ps": "",
                "ptb": ""
            }
            localStorage.setItem('post_data', JSON.stringify(post_data));
        } else {
            let post_data = JSON.parse(localStorage.getItem('post_data'));
            document.getElementById("post_title").value = post_data.pt;
            document.getElementById("post_description").value = post_data.pd;
            document.getElementById("post_categories").value = post_data.pc;
            document.getElementById("post_tag").value = post_data.ptag;
            document.getElementById("post_img").value = post_data.pi;
            document.getElementById("post_img_alt").value = post_data.pia;
            document.getElementById("zhiding").checked = post_data.pz;
            document.getElementById("shuxue").checked = post_data.ps;
            document.getElementById("tubiao").checked = post_data.ptb;
        }

        if (localStorage.getItem('contents') == null) {
            localStorage.setItem('contents', "");
        } else {
            if (localStorage.getItem('contents') !== "") {
                let contents = JSON.parse(localStorage.getItem('contents'));
                editor.setMarkdown(contents);
            }
        }



    }


    //实时更新上传图片框样式
    function changestyle() {
        var fb = document.getElementById('file-box2');
        fb.ondragover = function (ev) {
            //阻止浏览器默认打开文件的操作
            ev.preventDefault();
            this.style.borderColor = '#0097dfcc';
            this.style.background = '#67ccff1f';
        };
        fb.ondragleave = function () {
            //恢复边框颜色
            this.style.borderColor = '#efefef';
            this.style.background = 'none';
        };
        fb.ondrop = function (ev) {
            //恢复边框颜色
            this.style.borderColor = '#efefef';
            this.style.background = 'none';
        };
    }

    // 上传图片
    function upimg(fileName, base64, fileExt, el) {
        return new Promise((resolve, reject) => {
            let date1 = getCurrentDate(1);
            let date2 = getCurrentDate(2);
            let date3 = getCurrentDate(3);
            let fn = date3 + fileName;
            let base64Data = base64.replace(/^data:image\/\w+;base64,/, "");
            el.classList.add("breathing");

            fetch(`https://api.github.com/repos/${owner}/${repo}/contents/${img_path}/${date2}/${fn}`, {
                method: 'PUT',
                headers: {
                    'Authorization': 'Bearer ' + atoken,
                    'Content-Type': 'application/json',
                    'Accept': 'application/vnd.github.v3+json'
                },
                body: JSON.stringify({
                    "content": base64Data,
                    "message": date1 + fileName
                }),
            })
                .then(response => {
                    switch (response.status) {
                        case 200:
                        case 201:
                            console.log("新文件创建成功，状态码：", response.status);
                            el.parentNode.parentNode.removeChild(el.parentNode);
                            var imgsrc = `${imgcdn}/${owner}/${repo}/main/${img_path}/${date2}/${fn}`;
                            add_recent_img(imgsrc, fn);

                            break;
                        case 404: // Resource not found
                            console.error("资源未找到，状态码：", response.status);
                            // 可能需要处理找不到资源的情况
                            break;
                        case 409: // Conflict - 文件冲突，可能同时有其他更新操作
                            console.warn("文件冲突，状态码：", response.status);
                            // 处理冲突逻辑
                            break;
                        case 422: // Validation failed 或 被认定为垃圾请求
                            console.error("验证失败或请求被限制，状态码：", response.status);
                            // 需要检查数据是否符合要求或稍后再试
                            break;
                        default:
                            if (!response.ok) {
                                throw new Error(`未知错误，状态码：${response.status}`);
                            }
                    }
                    el.classList.remove("breathing"); // 不论结果如何，移除加载动画
                    resolve();
                })
                .catch(error => {
                    console.error('请求过程中出现问题：', error);
                    el.classList.remove("breathing"); // 确保错误时移除动画效果
                    reject(error);
                });
        });
    }

    // 实时更新拥有者和仓库名
    function get_name_repo() {
        let owner = document.getElementById("owner_");
        let repo = document.getElementById("repo_");
        let IBtext = document.getElementById("img_set_box_text");
        IBtext.innerText = "https://github.com/" + owner.value + "/" + repo.value + "/"
    }

    // 获取时间日期 1：时间日期  2：日期   3：时间
    function getCurrentDate(datetype) {
        var now = new Date();
        var year = now.getFullYear(); //得到年份
        var month = now.getMonth(); //得到月份
        var date = now.getDate(); //得到日期
        var day = now.getDay(); //得到周几
        var hour = now.getHours(); //得到小时
        var minu = now.getMinutes(); //得到分钟
        var sec = now.getSeconds(); //得到秒
        month = month + 1;
        if (month < 10) month = "0" + month;
        if (date < 10) date = "0" + date;
        if (hour < 10) hour = "0" + hour;
        if (minu < 10) minu = "0" + minu;
        if (sec < 10) sec = "0" + sec;
        var time = "";
        if (datetype == 1) {
            time = year + "-" + month + "-" + date + " " + hour + ":" + minu + ":" + sec + "-";
            return time;
        } else if (datetype == 2) {
            time = year + "-" + month + "-" + date;
            return time;
        } else if (datetype == 3) {
            time = hour + ":" + minu + ":" + sec + "-";
            return time;
        } else if (datetype == 4) {
            time = year + "-" + month + "-" + date + " " + hour + ":" + minu + ":" + sec;
            return time;
        }

    }

    // 将文件转换为Base64编码
    function toBase64() {
        var input = document.querySelector('input[type=file]');
        var files = input.files;
        if (files) {
            for (let i = 0; i < files.length; i++) {
                (function (index) { // 使用IIFE来创建独立的作用域
                    var file = files[index];
                    // 计算文件大小
                    var fileSize = 0;
                    var fileSizeMB = file.size / 1024 / 1024;
                    if (fileSizeMB < 1) {
                        fileSize = (file.size / 1024).toFixed(2) + " KB";
                    } else {
                        fileSize = fileSizeMB.toFixed(2) + " MB";
                    }

                    // 读取文件为base64
                    var reader = new FileReader();
                    reader.onloadend = function (e) {
                        var imgBase64 = e.target.result;
                        var base64Data = imgBase64.replace(/^data:image\/\w+;base64,/, "");
                        // 获取文件名和后缀
                        var fileName = file.name;
                        var fileExt = fileName.split('.').pop();
                        // 输出信息
                        // console.log("文件名: " + fileName);
                        // console.log("文件后缀: " + fileExt);
                        // console.log("格式后的base64编码: " + base64Data);
                        // console.log("文件大小: " + fileSize);
                        addimgbox(imgBase64, fileName, fileExt, fileSize);
                        check_preview();
                    };

                    // 读取文件
                    reader.readAsDataURL(file);
                })(i); // 立即执行IIFE并传入当前循环的索引
            }
        }
    }




    // 添加图片div
    function addimgbox(base64, fileName, fileExt, fileSize) {
        const ibox = document.createElement('div')
        ibox.innerHTML = [
            '<span style="cursor: pointer;width: 20px;height: 20px;color: #fff;background: #ff0000a6;padding: 0.3rem;line-height: 20px;display: flex;justify-content: center;align-items: center;font-size: 0.5rem;position: absolute;right: 0;top: 0; border-top-left-radius: 50%;border-bottom-left-radius: 50%;" class="f_btn" onclick="del_preview(this.parentNode)">X</span>',
            `<img src="${base64}" alt="" data-filename="${fileName}" data-fileext="${fileExt}" data-filesize="${fileSize}" onclick="toggleZoom(this)" style="object-fit: contain;object-position: center; width: 50px;height: 50px;background: #00000024;">`

        ].join('')
        ibox.classList.add("me-2");
        ibox.style.width = '50px';
        ibox.style.height = '50px';
        ibox.style.position = 'relative';

        document.getElementById("img_list_box").prepend(ibox);
    }

    //添加最近上传的图片
    function add_recent_img(src, fileName) {
        const ibox = `
        <div class="me-2 position-relative " style="width:50px;height:50px;">
            <div>
            <span style="cursor: pointer;width: 20px;height: 20px;color: #fff;background: #0089ffa6;padding: 0.3rem;line-height: 20px;display: flex;justify-content: center;align-items: center;font-size: 0.5rem;position: absolute;left: 0;top: 0; border-top-right-radius: 50%;border-bottom-right-radius: 50%;" class="f_btn" onclick="charu(this)">+</span>
            <span style="cursor: pointer;width: 20px;height: 20px;color: #fff;background: #ff0000a6;padding: 0.3rem;line-height: 20px;display: flex;justify-content: center;align-items: center;font-size: 0.5rem;position: absolute;right: 0;top: 0; border-top-left-radius: 50%;border-bottom-left-radius: 50%;" class="f_btn" onclick="del_recent_img(this.parentNode.parentNode)">X</span>
            </div>
            <img src="${src}" alt="" data-filename="${fileName}" onclick="toggleZoom(this)" style="object-fit: contain;object-position: center; width: 50px;height: 50px;background: #00000024;">
        </div>
        `;

        document.getElementById('recent_img_list_box').insertAdjacentHTML('afterbegin', ibox);

        if (localStorage.getItem('recent_img') === null) {
            localStorage.setItem('recent_img', JSON.stringify([[fileName, src]]));
        } else {
            const existingData = JSON.parse(localStorage.getItem('recent_img'));
            // 使用了扩展运算符(...)来创建现有数据的副本，并添加了新对象，这样可以避免直接修改原始数组。
            const newData = [...existingData, [fileName, src]];
            localStorage.setItem('recent_img', JSON.stringify(newData));
        }
    }

    //本地存储加载最近上传图片
    function load_recent_img() {
        if (localStorage.getItem('recent_img') !== null) {
            const existingData = JSON.parse(localStorage.getItem('recent_img'));
            localStorage.removeItem('recent_img');
            for (let i = 0; i < existingData.length; i++) {
                add_recent_img(existingData[i][1], existingData[i][0])
            }
        }
    }

    function del_recent_img(el) {
        del_preview(el);
        let recentimglist = document.getElementById("recent_img_list_box").querySelectorAll("img");
        localStorage.removeItem('recent_img');
        var datalist = [];
        for (let i = 0; i < recentimglist.length; i++) {
            let fn = recentimglist[i].getAttribute('data-filename');
            let data = [fn, recentimglist[i].src];
            datalist.unshift(data);
        }
        localStorage.setItem('recent_img', JSON.stringify(datalist));

    }


    // 放大缩小图片
    function toggleZoom(element) {
        if (element.classList.contains("zoomed")) {
            // 如果元素已有 zoomed 类，则移除它，实现缩小效果
            element.classList.remove("zoomed");
        } else {
            // 否则，添加 zoomed 类，实现放大效果
            element.classList.add("zoomed");
        }
    }

    //开关图床栏
    function checktuchuangstatus(tc_btn, tuchuang_switch_box) {
        let cfg = get_config();
        if (tc_btn.checked) {
            // console.log("图床已开启");
            tuchuang_switch_box.style.display = 'flex';
            cfg.tcan = true;
            // 初始化图床
            initPage();

        } else {
            // console.log("图床已关闭");
            tuchuang_switch_box.style.display = 'none';
            cfg.tcan = false;
        }
        set_config(cfg);
    }

    // 删除预览图片
    function del_preview(element) {
        element.parentNode.removeChild(element);
        check_preview();
    }

    // 检查是否有预览图片决定是否显示上传按钮
    function check_preview() {
        if (document.getElementById("img_list_box").innerHTML == "") {
            document.getElementById("preview_box").style.display = 'none';
        } else {
            document.getElementById("preview_box").style.display = 'flex';
        }
    }

    // 通过api获取tree信息
    async function get_info(url) {
        try {
            const response = await fetch(url, {
                method: 'GET',
                headers: {
                    "User-Agent": "Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/102.0.0.0 Safari/537.36",
                    'Authorization': 'Bearer ' + atoken,
                    'Content-Type': 'application/json',
                    'Accept': 'application/vnd.github.v3+json'
                }
            });

            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }
            const data = await response.json();
            // const dataheader = await response.headers;
            // console.log(dataheader.get("x-ratelimit-limit"));
            // console.log(dataheader.get("x-ratelimit-remaining"));
            // console.log(dataheader.get("x-ratelimit-used"));
            // console.log(dataheader.get("x-ratelimit-reset"));
            return data;
        } catch (error) {
            console.error('Error fetching repo list:', error);
            return "请求失败";
        }
    }

    // 通过分割斜杆进行循环 设置中图床路径（前后不能有斜杆）例：assets/img/blog_imgs 这样循环3次，
    async function traverseToPath(img_path, initialUrl = `https://api.github.com/repos/${owner}/${repo}/git/trees/main`) {
        const parts = img_path.split('/').filter(Boolean); // 过滤掉可能的空字符串
        let tree_url = initialUrl;

        for (const part of parts) {
            try {
                const data = await get_info(tree_url);
                const item = data.tree.find(item => item.path === part && item.type === 'tree');
                if (item) {
                    // console.log(`Found path part: ${part}, new tree_url: ${item.url}`);
                    tree_url = item.url;
                } else {
                    console.error(`未找到分割路径: ${part}`);
                    break; // 如果找不到对应部分，则终止循环
                }
            } catch (err) {
                console.error(`在此报错 ${part}:`, err);
                break; // 在发生错误时也终止循环
            }
        }
        return tree_url;
    }


    // 添加图床预览框内图片的div
    function add_imgsbox(path_, type_, url_) {
        if (type_ == "tree") {
            var imgboxhtml = `
            <div class="accordion-item mt-2 mb-2 border">
                <div class="accordion-header" id="header_${path_}">
                    <button class="accordion-button p-2 collapsed imgstitle" type="button" data-bs-toggle="collapse" data-bs-target="#contentbox_${path_}" aria-expanded="false" aria-controls="contentbox_${path_}" onclick="toggleAccordion(this) " data-shaurl="${url_}">${path_}</button>
                </div>
                <div id="contentbox_${path_}" class="accordion-collapse collapse" aria-labelledby="header_${path_}" data-bs-parent="#tc_content_box">
                    <div class="accordion-body scrollbar-box me-1" id="content_${path_}" style="display: grid;grid-template-columns: repeat(auto-fit, minmax(100px, 1fr));gap: 10px;overflow-y: auto;height: 500px;"></div>
                </div>
            </div>
            `;
            document.getElementById('tc_content_box').insertAdjacentHTML('afterbegin', imgboxhtml);

        }

    }

    //图床栏添加图片
    function add_imgs(date_, path_, nodeid) {
        var imgsbox = `
        <div class="position-relative">
            <div class="position-absolute AB" style="top: 50%;width: 100%;text-align: center;background: #0000005c;padding: 5px;">
                <span class="me-3" onclick="charu(this)" style="cursor: pointer;">📄</span>
                <span onclick="fuzhi(this)" style="cursor: pointer;">🔗</span>
            </div>
            <img src="${imgcdn}/${owner}/${repo}/main/${img_path}/${date_}/${path_}" alt="" class="w-100 h-100 rounded p-1" style="object-fit: contain;object-position: center;cursor: pointer;background: #00000024;" onclick="toggleZoom(this)"/>
        </div>
        `;
        document.getElementById(nodeid).insertAdjacentHTML('afterbegin', imgsbox);

    }

    // 刷新图床预览栏
    async function re_imglists_box() {
        try {
            const data = await traverseToPath(img_path);
            const lists = await get_info(data);
            localStorage.setItem('imglists', JSON.stringify(lists));
            console.log("数据存储到localStorage成功");
        } catch (err) {
            console.error("在re_imglists_box中捕获到错误:", err);
        }
    }

    async function postslist(initialUrl = `https://api.github.com/repos/${owner}/${repo}/git/trees/main`) {
        let tree_url = initialUrl;
        let part = "_posts"
        try {
            const data = await get_info(tree_url);
            const item = data.tree.find(item => item.path === part && item.type === 'tree');
            if (item) {
                // console.log(`Found path part: ${part}, new tree_url: ${item.url}`);
                tree_url = item.url;
            } else {
                console.error(`未找到路径: ${part}`);
            }
        } catch (err) {
            console.error(`在此报错 ${part}:`, err);
        }

        return tree_url;
    }
    // 刷新文章内容
    async function re_postlists_box() {
        document.getElementById("load_post").disabled = true;
        document.getElementById("home_content").innerHTML = '';
        add_loading(document.getElementById("home_content"));
        try {
            const data = await postslist();
            // console.log(data);
            const lists = await get_info(data);
            localStorage.setItem("postlist", JSON.stringify(lists.tree));
            let postlist_date = getCurrentDate(1);
            localStorage.setItem("postlist_date", postlist_date);

        } catch (err) {
            console.error("在re_imglists_box中捕获到错误:", err);
        }
        del_loading(document.getElementById("home_content"));
        document.getElementById("load_post").disabled = false;
        change_post_list();
    }

    //主页添加文章
    function add_posts_item(title, sha, url, date_, path) {
        var post_item = `
        <div class="post_item p-4 m-2 border rounded d-flex" data-sha="${sha}" data-url="${url}" data-path="${path}" data-title="${title}">
            <div class="flex-fill">
                <a href="https://binfen23.github.io/posts/${title}/" target="_blank" style="text-decoration: none;color: var(--bs-body-color);">${title}</a>
                <div style="font-size: 0.5rem;margin-top: 5px;color: #979797;">📅 ${date_}</div>
            </div>
            <div class="d-flex align-items-center justify-content-center">
                <span class="edit_btn border rounded p-1 m-1" style="cursor: pointer;font-size: 0.8rem;" onclick="edit_post(this)">✏️</span>
                <span class="edit_btn border rounded p-1 m-1" style="cursor: pointer;font-size: 0.8rem;" onclick="delete_post(this)">🗑️</span>
            </div>
        </div>
        `;
        document.getElementById("home_content").insertAdjacentHTML('beforeend', post_item);

    }

    function change_post_list() {
        if (localStorage.getItem('postlist') !== null && localStorage.getItem('postlist') !== "") {
            let postlist = JSON.parse(localStorage.getItem('postlist'));
            let postlist_date = localStorage.getItem('postlist_date');
            document.getElementById("postlist_changedate").innerText = postlist_date + '加载文章内容';
            for (let i = 0; i < postlist.length; i++) {
                let path = postlist[i].path;
                let dateStr = path.split("-").slice(0, 3).join("-");
                // console.log(dateStr);
                let parts = path.split('-');
                let title = " ";
                if (path == ".placeholder") {
                    continue
                }
                if (parts[3] !== ".md" && path !== ".placeholder") {
                    title = parts[3].replace(/\.md$/, '');
                }
                // console.log(title)
                let sha = postlist[i].sha;
                let url = postlist[i].url;
                add_posts_item(title, sha, url, dateStr, postlist[i].path);
            }

        }
    }


    // 图床标题按钮判断展开还是闭合
    function toggleAccordion(el) {
        var isCollapsed = el.classList.contains('collapsed');
        if (isCollapsed) {
            // console.log("闭合:" + el.innerText);
            del_loading(el.parentNode.nextElementSibling)//移除加载动画
        } else {
            // console.log("展开:" + el.innerText);

            add_loading(el.parentNode.nextElementSibling);//正在加载动画

            if (localStorage.getItem(el.innerText) === null) {
                // 加载url
                get_info(el.getAttribute('data-shaurl'))
                    .then(lists => {
                        localStorage.setItem(el.innerText, JSON.stringify(lists));
                        del_loading(el.parentNode.nextElementSibling)//移除正在加载动画
                        document.getElementById(`content_${el.innerText}`).innerHTML = "";
                        var item_img_lists = JSON.parse(localStorage.getItem(el.innerText));
                        var item_img_tree = item_img_lists.tree;
                        for (let i = 0; i < item_img_tree.length; i++) {
                            add_imgs(el.innerText, item_img_tree[i].path, `content_${el.innerText}`)
                        }
                    })
                    .catch(err2 => {
                        console.error("无法获取最后一个tree返回的数据", err2);
                    })

            } else {
                del_loading(el.parentNode.nextElementSibling); //移除加载动画
                document.getElementById(`content_${el.innerText}`).innerHTML = "";
                var item_img_lists = JSON.parse(localStorage.getItem(el.innerText));
                var item_img_tree = item_img_lists.tree;
                for (let i = 0; i < item_img_tree.length; i++) {
                    add_imgs(el.innerText, item_img_tree[i].path, `content_${el.innerText}`)
                }
            }

        }
    }


    // 添加加载loading
    function add_loading(el) {
        el.insertAdjacentHTML('afterbegin', '<div class="loader"></div>');
    }

    // 移除加载loading
    function del_loading(el) {
        var loaders = el.querySelectorAll('.loader');
        for (var i = 0; i < loaders.length; i++) {
            el.removeChild(loaders[i]);
        }
    }


    function add_imglists() {
        var img_lists = JSON.parse(localStorage.getItem('imglists'));
        if (img_lists == "请求失败") {
            var imgsbox = `
                <div class="w-100 h-100 d-flex flex-column align-items-center justify-content-center text-center">
                    ⚠️请求失败 (╯°Д°)╯︵ ┻━┻
                    <p style="font-size: 0.5rem;color: #979797;margin: 0.5rem;">检查拥有者、仓库名、图片路径、Token</p>
                </div>
            `;
            document.getElementById("tc_content_box").insertAdjacentHTML('afterbegin', imgsbox);
        } else {
            var img_tree = img_lists.tree;
            for (let i = 0; i < img_tree.length; i++) {
                add_imgsbox(img_tree[i].path, img_tree[i].type, img_tree[i].url);
            }
        }

    }

    async function initPage() {
        try {
            if (localStorage.getItem('imglists') === null) {
                await re_imglists_box();
                del_loading(document.getElementById("tc_content_box"));
                add_imglists();
                document.getElementById('update_img').disabled = false;
            } else {
                del_loading(document.getElementById("tc_content_box"));
                add_imglists();
                document.getElementById('update_img').disabled = false;
            }
        } catch (err) {
            console.error("初始化页面时发生错误:", err);
            document.getElementById('update_img').disabled = false;
        }
    }

    // 查找并复制图片链接的函数
    function fuzhi(element) {
        // 获取当前点击元素的父元素
        var parentElement = element.parentElement;
        // 从父元素的兄弟元素中找到img标签
        var imgElement = parentElement.previousElementSibling || parentElement.nextElementSibling;

        // 确保找到了img元素
        if (imgElement && imgElement.tagName.toLowerCase() === 'img') {
            // 获取img的src属性
            var imgSrc = imgElement.src;
            // 执行复制操作
            copyTextToClipboard(imgSrc);
            // alert('图片链接已复制到剪贴板！');
        } else {
            console.error('未找到相邻的img元素');
        }
    }

    // 用于插入或处理图片链接的功能函数，这里仅为示例，具体实现取决于需求
    function charu(element) {
        var pp_Element_img_list = element.parentElement.parentElement.querySelectorAll("img");
        // console.log(pp_Element_img_list);
        var imgSrc = pp_Element_img_list[0].src;
        // document.getElementsByClassName("ProseMirror")[0].append(`![image](${imgSrc})`)
        editor.insertText(`![image](${imgSrc})`);

    }

    // 复制文本到剪贴板的辅助函数
    function copyTextToClipboard(text) {
        if (navigator.clipboard && navigator.clipboard.writeText) {
            navigator.clipboard.writeText(text).then(function () {
                // 已复制成功的处理
            }, function (err) {
                console.error('无法复制到剪贴板:', err);
            });
        } else {
            // Fallback for older browsers
            var textArea = document.createElement("textarea");
            textArea.value = text;
            // Make it invisible
            textArea.style.position = 'absolute';
            textArea.style.left = '-9999px';
            document.body.appendChild(textArea);
            textArea.select();
            try {
                document.execCommand('copy');
                alert('复制成功');
            } catch (ex) {
                console.error('无法复制文本:', ex);
            }
            document.body.removeChild(textArea);
        }
    }

    function updateimgdata() {
        document.getElementById('update_img').disabled = true;
        var imgstitlelsit = document.getElementsByClassName("imgstitle");
        for (let i = 0; i < imgstitlelsit.length; i++) {
            localStorage.removeItem(imgstitlelsit[i].innerText);
        }
        localStorage.removeItem("imglists");
        document.getElementById("tc_content_box").innerHTML = "";
        add_loading(document.getElementById("tc_content_box"));
        initPage();



    }


    async function get_img_list() {
        document.getElementById('uploadimg').disabled = true;
        let upimglist = document.getElementById("img_list_box").querySelectorAll("img");
        for (let i = 0; i < upimglist.length; i++) {
            // console.log(`Processing image at index ${i}`);
            let iname = upimglist[i].getAttribute('data-filename');
            let imgBase64 = upimglist[i].src;
            let Ext = upimglist[i].getAttribute('data-fileext');
            // console.log(`Index: ${i}, Name: ${name}, Ext: ${Ext}`);
            // console.log("节点：")
            // console.log(upimglist[i])
            try {
                await upimg(iname, imgBase64, Ext, upimglist[i]);
                document.getElementById('uploadimg').disabled = false;
                check_preview();
            } catch (error) {
                console.error(`Error uploading image ${name}: `, error);
                document.getElementById('uploadimg').disabled = false;
                // 处理错误，可以选择继续循环或中断
            }

        }
    }

    //文字转base64
    function btoaUnicode(str) {
        return btoa(encodeURIComponent(str).replace(/%([0-9A-F]{2})/g, function (match, p1) {
            return String.fromCharCode(parseInt(p1, 16));
        }));
    }
    //发布文章
    function post_() {
        return new Promise((resolve, reject) => {
            document.getElementById('_post').disabled = true;
            var title_ = document.getElementById("post_title").value;
            var description_ = document.getElementById("post_description").value;
            var categories_ = document.getElementById("post_categories").value.replace(/，/g, ',');
            var tags_ = document.getElementById("post_tag").value.replace(/，/g, ',');
            var pin_ = document.getElementById("zhiding").checked;
            var math_ = document.getElementById("shuxue").checked;
            var mermaid_ = document.getElementById("tubiao").checked;
            var _date = getCurrentDate(4);
            var _date2 = getCurrentDate(2);
            var _file_name = `${_date2}-${title_}.md`;
            var post_img_src = document.getElementById("post_img").value;
            var post_img_alt = document.getElementById("post_img_alt").value;
            var img_s = "";
            if (post_img_src !== "") {
                img_s = "\nimage:\n    path: " + post_img_src + "\n    lqip: data:image/webp;base64,UklGRpoAAABXRUJQVlA4WAoAAAAQAAAADwAABwAAQUxQSDIAAAARL0AmbZurmr57yyIiqE8oiG0bejIYEQTgqiDA9vqnsUSI6H+oAERp2HZ65qP/VIAWAFZQOCBCAAAA8AEAnQEqEAAIAAVAfCWkAALp8sF8rgRgAP7o9FDvMCkMde9PK7euH5M1m6VWoDXf2FkP3BqV0ZYbO6NA/VFIAAAA\n    alt: " + post_img_alt;
            }
            var post_c = editor.getMarkdown();
            var md_title_c = [
                "---\ntitle: ", title_,
                "\ndescription: ", description_,
                "\ndate: ", _date + " +0800",
                "\ncategories: [", categories_, "]\ntags: [", tags_,
                "]\npin: ", pin_,
                "\nmath: ", math_,
                "\nmermaid: ", mermaid_,
                img_s,
                "\n---\n"
            ].join('');

            var b_content = md_title_c + post_c;
            var base64_content = btoaUnicode(b_content);

            console.log(md_title_c);
            console.log(base64_content);
            console.log(_file_name);

            fetch(`https://api.github.com/repos/${owner}/${repo}/contents/_posts/${_file_name}`, {
                method: 'PUT',
                headers: {
                    'Authorization': 'Bearer ' + atoken,
                    'Content-Type': 'application/json',
                    'Accept': 'application/vnd.github.v3+json'
                },
                body: JSON.stringify({
                    "content": base64_content,
                    "message": `发布文章《${_file_name}》`
                }),
            })
                .then(response => {
                    switch (response.status) {
                        case 200:
                        case 201:
                            let t = ["post_title", "post_description", "post_categories", "post_tag", "post_img", "post_img_alt"];
                            for (let i = 0; i < t.length; i++) {
                                document.getElementById(t[i]).value = "";
                            }
                            document.getElementById("zhiding").checked = false;
                            document.getElementById("shuxue").checked = false;
                            document.getElementById("tubiao").checked = false;
                            editor.reset();
                            alert("(و•̀ㅂ•́)و✧ 发表成功 🎉🎉", "success");
                            console.log("(و•̀ㅂ•́)و✧ 发表成功 🎉🎉", response.status);
                            break;
                        case 404: // Resource not found
                            alert("(;´༎ຶД༎ຶ`) 请求链接出错，请检查拥有者和仓库名", "danger");
                            console.error("(;´༎ຶД༎ຶ`) 请求链接出错，请检查拥有者和仓库名 状态码：", response.status);
                            // 可能需要处理找不到资源的情况
                            break;
                        case 409: // Conflict - 文件冲突，可能同时有其他更新操作
                            alert("Σ(☉д⊙) 当前文件名与github端的文件名冲突", "danger");
                            console.warn("Σ(☉д⊙) 当前文件名与github端的文件名冲突 状态码：", response.status);
                            // 处理冲突逻辑
                            break;

                        case 401:
                        case 422: // Validation failed 或 被认定为垃圾请求
                            alert("(|||ﾟдﾟ) Token已经超过github次数限制，需等待恢复次数", "danger");
                            console.error("(|||ﾟдﾟ) Token已经超过github次数限制，需等待恢复次数 状态码：", response.status);
                            // 需要检查数据是否符合要求或稍后再试
                            break;
                        default:
                            if (!response.ok) {
                                alert(`(┐ ◟;ﾟдﾟ)ノ 未知错误，状态码：${response.status}`, "danger");
                                throw new Error(`(┐ ◟;ﾟдﾟ)ノ 未知错误，状态码 ${response.status}`);
                            }
                    }
                    document.getElementById('_post').disabled = false;
                    resolve();
                })
                .catch(error => {
                    alert("｡ﾟヽ(ﾟ´Д`)ﾉﾟ｡ 请求链接出错，请检查Token", "danger");
                    console.error('｡ﾟヽ(ﾟ´Д`)ﾉﾟ｡ 请求链接出错，请检查Token ', error);
                    document.getElementById('_post').disabled = false;
                    reject(error);
                });
        });
    }

    //修改文章
    function post_2() {
        return new Promise((resolve, reject) => {
            document.getElementById('_post2').disabled = true;
            var title_ = document.getElementById("post_title").value;
            var description_ = document.getElementById("post_description").value;
            var categories_ = document.getElementById("post_categories").value.replace(/，/g, ',');
            var tags_ = document.getElementById("post_tag").value.replace(/，/g, ',');
            var pin_ = document.getElementById("zhiding").checked;
            var math_ = document.getElementById("shuxue").checked;
            var mermaid_ = document.getElementById("tubiao").checked;
            var _date = getCurrentDate(4);
            var _date2 = getCurrentDate(2);
            var _data = JSON.parse(localStorage.getItem('post_edit_data'));
            var _file_name = _data.path;
            var post_img_src = document.getElementById("post_img").value;
            var post_img_alt = document.getElementById("post_img_alt").value;
            var img_s = "";
            if (post_img_src !== "") {
                img_s = "\nimage:\n    path: " + post_img_src + "\n    lqip: data:image/webp;base64,UklGRpoAAABXRUJQVlA4WAoAAAAQAAAADwAABwAAQUxQSDIAAAARL0AmbZurmr57yyIiqE8oiG0bejIYEQTgqiDA9vqnsUSI6H+oAERp2HZ65qP/VIAWAFZQOCBCAAAA8AEAnQEqEAAIAAVAfCWkAALp8sF8rgRgAP7o9FDvMCkMde9PK7euH5M1m6VWoDXf2FkP3BqV0ZYbO6NA/VFIAAAA\n    alt: " + post_img_alt;
            }
            var post_c = editor.getMarkdown();
            var md_title_c = [
                "---\ntitle: ", title_,
                "\ndescription: ", description_,
                "\ndate: ", _data.date,
                "\ncategories: [", categories_, "]\ntags: [", tags_,
                "]\npin: ", pin_,
                "\nmath: ", math_,
                "\nmermaid: ", mermaid_,
                img_s,
                "\n---\n"
            ].join('');

            var b_content = md_title_c + "> 最近修改日期：" + _date + "  \n" + post_c;
            var base64_content = btoaUnicode(b_content);

            fetch(`https://api.github.com/repos/${owner}/${repo}/contents/_posts/${_file_name}`, {
                method: 'PUT',
                headers: {
                    'Authorization': 'Bearer ' + atoken,
                    'Content-Type': 'application/json',
                    'Accept': 'application/vnd.github.v3+json'
                },
                body: JSON.stringify({
                    "content": base64_content,
                    "message": `修改文章《${_file_name}》`,
                    "committer": {
                        "name": name_,
                        "email": email_
                    },
                    "sha": _data.sha,
                }),
            })
                .then(response => {
                    switch (response.status) {
                        case 200:
                        case 201:
                            let t = ["post_title", "post_description", "post_categories", "post_tag", "post_img", "post_img_alt"];
                            for (let i = 0; i < t.length; i++) {
                                document.getElementById(t[i]).value = "";
                            }
                            document.getElementById("zhiding").checked = false;
                            document.getElementById("shuxue").checked = false;
                            document.getElementById("tubiao").checked = false;
                            editor.reset();
                            document.getElementById('_post2').disabled = false;
                            document.getElementById('_post2').style.display = "none";
                            document.getElementById('_post').style.display = "block";
                            alert("(و•̀ㅂ•́)و✧ 发表成功 🎉🎉", "success");
                            console.log("(و•̀ㅂ•́)و✧ 发表成功 🎉🎉", response.status);
                            break;
                        case 404: // Resource not found
                            alert("(;´༎ຶД༎ຶ`) 请求链接出错，请检查拥有者和仓库名", "danger");
                            console.error("(;´༎ຶД༎ຶ`) 请求链接出错，请检查拥有者和仓库名 状态码：", response.status);
                            // 可能需要处理找不到资源的情况
                            break;
                        case 409: // Conflict - 文件冲突，可能同时有其他更新操作
                            alert("Σ(☉д⊙) 当前文件名与github端的文件名冲突", "danger");
                            console.warn("Σ(☉д⊙) 当前文件名与github端的文件名冲突 状态码：", response.status);
                            // 处理冲突逻辑
                            break;

                        case 401:
                        case 422: // Validation failed 或 被认定为垃圾请求
                            alert("(|||ﾟдﾟ) Token已经超过github次数限制，需等待恢复次数", "danger");
                            console.error("(|||ﾟдﾟ) Token已经超过github次数限制，需等待恢复次数 状态码：", response.status);
                            // 需要检查数据是否符合要求或稍后再试
                            break;
                        default:
                            if (!response.ok) {
                                alert(`(┐ ◟;ﾟдﾟ)ノ 未知错误，状态码：${response.status}`, "danger");
                                throw new Error(`(┐ ◟;ﾟдﾟ)ノ 未知错误，状态码 ${response.status}`);
                            }
                    }
                    document.getElementById('_post2').disabled = false;
                    resolve();
                })
                .catch(error => {
                    alert("｡ﾟヽ(ﾟ´Д`)ﾉﾟ｡ 请求链接出错，请检查Token", "danger");
                    console.error('｡ﾟヽ(ﾟ´Д`)ﾉﾟ｡ 请求链接出错，请检查Token ', error);
                    document.getElementById('_post2').disabled = false;
                    reject(error);
                });
        });
    }

    function change_home() {
        if (document.getElementById("owner_").value == "") {
            document.getElementById("no_set").style.display = "flex";
            document.getElementById("post_box").style.display = "none";
            document.getElementById("ptext").innerText = '⚠️还未设置拥有者 ';
        } else
            if (document.getElementById("repo_").value == "") {
                document.getElementById("no_set").style.display = "flex";
                document.getElementById("post_box").style.display = "none";
                document.getElementById("ptext").innerText = '⚠️还未设置仓库名 ';
            } else
                if (document.getElementById("name_").value == "") {
                    document.getElementById("no_set").style.display = "flex";
                    document.getElementById("post_box").style.display = "none";
                    document.getElementById("ptext").innerText = '⚠️还未设置提交者 ';
                } else
                    if (document.getElementById("email_").value == "") {
                        document.getElementById("no_set").style.display = "flex";
                        document.getElementById("post_box").style.display = "none";
                        document.getElementById("ptext").innerText = '⚠️还未设置邮箱 ';
                    } else
                        if (document.getElementById("accessTokenInput").value == "") {
                            document.getElementById("no_set").style.display = "flex";
                            document.getElementById("post_box").style.display = "none";
                            document.getElementById("ptext").innerText = '⚠️还未设置Token ';
                        } else
                            if (document.getElementById("owner_").value !== "" && document.getElementById("repo_").value !== "" && document.getElementById("accessTokenInput").value !== "") {
                                document.getElementById("no_set").style.display = "none";
                                document.getElementById("post_box").style.display = "flex";
                            }



    }
    function decodeBase64(base64) {
        // 解码Base64字符串
        const binaryString = window.atob(base64);
        // 创建一个ArrayBuffer视图
        const len = binaryString.length;
        const bytes = new Uint8Array(len);
        // 将解码后的二进制字符串转换为Uint8Array
        for (let i = 0; i < len; i++) {
            bytes[i] = binaryString.charCodeAt(i);
        }
        // 创建一个TextDecoder实例来处理UTF-8编码
        const decoder = new TextDecoder('utf-8');
        // 返回UTF-8解码后的字符串
        return decoder.decode(bytes);
    }

    // 编辑文章
    async function geteditpost(path, sha, title) {
        if (title == " ") {
            title = "";
        }
        try {
            const response = await fetch(`https://api.github.com/repos/${owner}/${repo}/contents/_posts/${path}`, {
                method: 'PUT',
                headers: {
                    'Authorization': `token ${atoken}`,
                    'Accept': 'application/vnd.github.v3+json'
                },
                body: JSON.stringify({
                    message: `编辑文章《${title}》`,
                    committer: {
                        name: name_,
                        email: email_
                    },
                    sha: sha,
                })
            });

            if (!response.ok) {
                throw new Error(`${response.status}`);
            }

            return await response.json();
        } catch (error) {
            console.error('删除出错:', error);
            throw error;
        }
    }

    async function edit_post(node) {
        // console.log(pnode.getAttribute('data-sha'))
        node.style.display = 'none';
        add_loading(node.parentNode);
        let pnode = node.parentNode.parentNode
        try {
            const dlist = await get_info(pnode.getAttribute('data-url'));
            // console.log(decodeBase64(dlist.content));
            new bootstrap.Tab(document.querySelector('#w_blog-tab')).show();
            let datac = decodeBase64(dlist.content);
            var setdict = {};
            var strlist = datac.match(/^---\n(.*?)\n---/s)[0].split('\n');
            for (let i = 0; i < strlist.length; i++) {
                if (strlist[i] !== "---") {
                    let item = strlist[i].trimStart();
                    var items = item.split(": ");
                    if (items.length == 2) {
                        setdict[items[0]] = items[1];
                    }

                }
            }
            // console.log(setdict)

            // console.log(content);
            // console.log(JSON.stringify(setdict, null, 2));
            document.getElementById("post_title").value = setdict.title;
            if (setdict.description !== "") { document.getElementById("post_description").value = setdict.description; };
            if (setdict.categories !== "") { document.getElementById("post_categories").value = setdict.categories.slice(1, -1); };
            if (setdict.tags !== "") { document.getElementById("post_tag").value = setdict.tags.slice(1, -1); };
            if (setdict.path !== undefined && setdict.path !== "") { document.getElementById("post_img").value = setdict.path; };
            if (setdict.alt !== undefined && setdict.alt !== "") { document.getElementById("post_img").value = setdict.alt; };
            if (setdict.pin == "true") { document.getElementById("zhiding").checked = true; } else { document.getElementById("zhiding").checked = false; };
            if (setdict.math == "true") { document.getElementById("shuxue").checked = true; } else { document.getElementById("shuxue").checked = false; };
            if (setdict.mermaid == "true") { document.getElementById("tubiao").checked = true; } else { document.getElementById("tubiao").checked = false; };
            let content = datac.replace(/---[\s\S]*---[\r\n]*/g, '');
            editor.setMarkdown(content);

            document.getElementById("_post").style.display = "none";
            document.getElementById("_post2").style.display = "block";


            let dataItems = strlist.filter(item => item.indexOf('date') === 0);

            let ped = {
                "sha": pnode.getAttribute('data-sha'),
                "path": pnode.getAttribute('data-path'),
                "date": dataItems[0].split(": ")[1],
            }
            localStorage.setItem('post_edit_data', JSON.stringify(ped));














        } catch (err) {
            console.error(`编辑文章时候请求失败 `, err);
        }
        node.style.display = 'block';
        del_loading(node.parentNode);

    }

    // 封装 DELETE 请求到 GitHub 的函数
    async function deleteFileFromGitHub(path, sha, title) {
        if (title == " ") {
            title = "";
        }
        try {
            const response = await fetch(`https://api.github.com/repos/${owner}/${repo}/contents/_posts/${path}`, {
                method: 'DELETE',
                headers: {
                    'Authorization': `token ${atoken}`,
                    'Accept': 'application/vnd.github.v3+json'
                },
                body: JSON.stringify({
                    message: `删除文章《${title}》`,
                    committer: {
                        name: name_,
                        email: email_
                    },
                    sha: sha,
                })
            });

            if (!response.ok) {
                throw new Error(`${response.status}`);
            }

            return await response.json();
        } catch (error) {
            console.error('删除出错:', error);
            throw error;
        }
    }


    function delete_post(node) {
        document.getElementById("del_msbox").style.display = 'flex';
        setTimeout(function () {
            document.getElementById("del_msbox").style.opacity = '1';
            document.getElementById("del_msbox2").style.bottom = '0';
        }, 120)
        document.getElementById('e_del').addEventListener('click', async function () {
            document.getElementById("del_msbox").style.opacity = '0';
            document.getElementById("del_msbox2").style.bottom = '100%';
            setTimeout(function () {
                document.getElementById("del_msbox").style.display = 'none';
            }, 800)
            node.style.display = 'none';
            add_loading(node.parentNode);
            let ppnode = node.parentNode.parentNode;
            let sha = ppnode.getAttribute('data-sha');
            let path = ppnode.getAttribute('data-path');
            let title = ppnode.getAttribute('data-title');

            try {
                const result = await deleteFileFromGitHub(path, sha, title);
                console.log(result)
                // console.log('删除完成');
                re_postlists_box();
                // return result;
            } catch (error) {
                alert("删除文章失败，详情看控制台输出", "danger");
                if (error == "Error: 404") {
                    console.error("短时间内删除太频繁了！实际文章已经删除，需等待github的actions执行完毕，重新加载文章列表")
                }

                node.style.display = 'block';
                del_loading(node.parentNode);
                throw error;
            }

        });

        document.getElementById('e_del').removeEventListener('click', arguments.callee);//取消监听点击事件避免重复触发




    }


    //速率显示
    function sl() {
        let box = document.getElementById("sulv");
        let tokne = document.getElementById("accessTokenInput").value;
        let head = {};
        if (tokne !== "") {
            head = {
                'Authorization': `token ${tokne}`
            }
        }
        box.innerHTML = '';
        add_loading(box);
        fetch('https://api.github.com/rate_limit', {
            headers: head
        })
            .then(response => {
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                return response.json();
            })
            .then(data => {
                // console.log(data);
                let zsl = data.rate.limit;
                let sysl = data.rate.remaining;
                let percentage = Math.round((sysl / zsl) * 100);
                const date = new Date(data.rate.reset * 1000);
                const year = date.getFullYear();
                const month = (date.getMonth() + 1).toString().padStart(2, '0');
                const day = date.getDate().toString().padStart(2, '0');
                const hours = date.getHours().toString().padStart(2, '0');
                const minutes = date.getMinutes().toString().padStart(2, '0');
                const seconds = date.getSeconds().toString().padStart(2, '0');
                const formattedDateTime = `${year}-${month}-${day} ${hours}:${minutes}:${seconds}`;
                const ibox = `
                <div class="progress mb-1" role="progressbar" aria-valuemin="0" aria-valuemax="100"style="width: 100%;">
                    <div class="progress-bar" style="width: ${percentage}%;">${sysl}</div>
                </div>
                <span style="font-size: 0.5rem;">总速率 ${zsl} 重置时间日期 ${formattedDateTime}</span><span class="edit_btn border rounded p-1 m-1" style="cursor: pointer;font-size: 0.8rem;" onclick="sl()">♻️</span>
                `;
                document.getElementById('sulv').insertAdjacentHTML('beforeend', ibox);
                del_loading(box);
            })
            .catch(error => {
                console.error('Error:', error);
                del_loading(box);
            });
    }
</script>


<script>

    ready(function () {
        window.onbeforeunload = function (e) {
            return '确定离开此页吗？';
        }
        console.info('%c Author %c' + ' Zeb', 'background:#70a1d7;color:#ffffff;border-radius: 2px;', 'color:auto;');
        console.info('%c Alert %c' + '  ( ´◔ ‸◔`) 你是想看我的屎山代码吗？', 'background:#a1de93;color:#ffffff;border-radius: 2px;', 'color:auto;');
        console.info('%c Alert %c' + '  ( ‾ʖ̫‾) 要不去Github瞧瞧？', 'background:#f7f48b;color:#ffffff;border-radius: 2px;', 'color:auto;')
        console.info('%c Alert %c' + '  ୧(๑•̀⌄•́๑)૭ 顺便给我个⭐️Star鸭~', 'background:#f47c7c;color:#ffffff;border-radius: 2px;', 'color:auto;')
        let cfg = get_config();
        change_ui(cfg);
        owner = cfg.sz.yyz;
        repo = cfg.sz.cangku;
        name_ = cfg.sz.tjz;
        email_ = cfg.sz.email;
        img_path = cfg.sz.lujing;
        atoken = cfg.sz.token;

        if (cfg.sz.img_cdn == "") {
            imgcdn = "https://raw.githubusercontent.com";
        } else {
            imgcdn = cfg.sz.img_cdn;
        }



        changestyle(); //拖拽文件更新样式

        get_name_repo(); //实时更新设置页面拥有者和仓库名的标签

        check_preview(); //初始化图片预览框

        change_home(); //初始化主页是否设置了用户信息

        change_post(); //初始化文章保存内容

        change_post_list(); //初始化文章内容

        sl();//获取token速率






        document.getElementById("owner_").addEventListener('change', get_name_repo);
        document.getElementById("repo_").addEventListener('change', get_name_repo);

        // 触发 发布按钮

        document.getElementById('_post').addEventListener('click', function () {
            // alert('点击了发表', 'success');
            let post_t = document.getElementById("post_title").value;
            let post_c = editor.getMarkdown();
            if (post_t == "") {
                alert("文章标题不能为空", "warning");
            } else if (post_c == "") {
                alert("文章内容不能为空", "warning");
            } else {
                document.getElementById("post_msbox").style.display = 'flex';
                setTimeout(function () {
                    document.getElementById("post_msbox").style.opacity = '1';
                    document.getElementById("post_msbox2").style.bottom = '0';
                }, 120)

            }

        });

        // 触发 发布修改按钮
        document.getElementById('_post2').addEventListener('click', function () {
            // alert('点击了发表', 'success');
            let post_t = document.getElementById("post_title").value;
            let post_c = editor.getMarkdown();
            if (post_t == "") {
                alert("文章标题不能为空", "warning");
            } else if (post_c == "") {
                alert("文章内容不能为空", "warning");
            } else {
                document.getElementById("post_msbox").style.display = 'flex';
                setTimeout(function () {
                    document.getElementById("post_msbox").style.opacity = '1';
                    document.getElementById("post_msbox2").style.bottom = '0';
                }, 120)

            }

        });





        // 触发 主页跳转到设置页面的按钮
        if (document.querySelector('#set_info')) {
            document.querySelector('#set_info').addEventListener('click', function (event) {
                new bootstrap.Tab(document.querySelector('#settings-tab')).show();
            });
        } else {
            alert('无法获取设置信息按钮', 'warning')
        }


        // 点击 主页-标签页 触发事件
        document.querySelector('#home-tab').addEventListener('show.bs.tab', function (event) {
            // alert('点击了主页', 'success')
            change_home();
        });

        // 点击 写文章-标签页 触发事件
        document.querySelector('#w_blog-tab').addEventListener('show.bs.tab', function (event) {
            // alert('点击了写文章', 'success');

        });

        // 点击 设置-标签页 触发事件
        document.querySelector('#settings-tab').addEventListener('show.bs.tab', function (event) {
            // alert('点击了设置', 'success')
        });


        // 触发 设置-标签页 显示/隐藏token值的事件
        document.getElementById('show_hide').addEventListener('click', function () {
            var passwordInput = document.getElementById('accessTokenInput');
            var currentType = passwordInput.getAttribute('type');
            var newType = currentType === 'password' ? 'text' : 'password';
            passwordInput.setAttribute('type', newType);

            // 如果需要，也可以在这里改变按钮文本以指示当前状态
            this.textContent = newType === 'password' ? '显示' : '隐藏';
        });

        // 设置-标签页 保存按钮的触发事件
        document.getElementById('save_info').addEventListener('click', function () {
            if (document.getElementById("owner_").value == "") {
                alert("拥有者不能为空", "warning");
            } else if (document.getElementById("repo_").value == "") {
                alert("仓库名不能为空", "warning");
            } else if (document.getElementById("name_").value == "") {
                alert("提交者不能为空", "warning")
            } else if (document.getElementById("email_").value == "") {
                alert("邮箱不能为空", "warning")
            } else if (document.getElementById("accessTokenInput").value == "") {
                alert("Token不能为空", "warning");
            } else {
                let cfg = get_config();
                cfg.sz.yyz = document.getElementById("owner_").value;
                cfg.sz.cangku = document.getElementById("repo_").value;
                cfg.sz.tjz = document.getElementById("name_").value;
                cfg.sz.email = document.getElementById("email_").value;
                cfg.sz.token = document.getElementById("accessTokenInput").value;
                cfg.sz.img_cdn = document.getElementById("img_cdn").value;
                cfg.sz.lujing = document.getElementById("img_set_box_").value;
                set_config(cfg);
                owner = document.getElementById("owner_").value;
                repo = document.getElementById("repo_").value;
                name_ = document.getElementById("name_").value;
                email_ = document.getElementById("email_").value;
                atoken = document.getElementById("accessTokenInput").value;
                imgcdn = document.getElementById("img_cdn").value;
                img_path = document.getElementById("img_set_box_").value;


                //    跳转主页
                new bootstrap.Tab(document.querySelector('#home-tab')).show();

            }



        })





        // 绑定图床栏开关
        var tc_switch_btn = document.getElementById("tuchuang")
        tc_switch_btn.addEventListener('change', function () {
            checktuchuangstatus(tc_switch_btn, document.getElementById("tuchuang_box"));
        });
        checktuchuangstatus(tc_switch_btn, document.getElementById("tuchuang_box"));



        //绑定图床刷新按钮
        document.getElementById("update_img").addEventListener('click', updateimgdata);
        document.getElementById("uploadimg").addEventListener('click', get_img_list);

        //本地存储加载最近上传图片
        load_recent_img();




        document.getElementById('c_post').addEventListener('click', function () {
            document.getElementById("post_msbox").style.opacity = '0';
            document.getElementById("post_msbox2").style.bottom = '100%';
            setTimeout(function () {
                document.getElementById("post_msbox").style.display = 'none';
            }, 800)


        })
        document.getElementById('e_post').addEventListener('click', function () {
            if (document.getElementById("_post").style.display !== "none") {
                post_();
            } else {
                post_2();
            }
            document.getElementById("post_msbox").style.opacity = '0';
            document.getElementById("post_msbox2").style.bottom = '100%';
            setTimeout(function () {
                document.getElementById("post_msbox").style.display = 'none';
            }, 1000)
        })

        document.getElementById('c_del').addEventListener('click', function () {
            document.getElementById("del_msbox").style.opacity = '0';
            document.getElementById("del_msbox2").style.bottom = '100%';
            setTimeout(function () {
                document.getElementById("del_msbox").style.display = 'none';
            }, 800)


        })

        document.getElementById('load_post').addEventListener('click', function () {
            // console.log("点击加载文章");
            re_postlists_box()
        })



        document.getElementById('zhiding').addEventListener('change', function () {
            let checked_ = document.getElementById('zhiding').checked;
            let cfg = JSON.parse(localStorage.getItem('post_data'));
            cfg.pz = checked_;
            localStorage.setItem('post_data', JSON.stringify(cfg));
        });
        document.getElementById('shuxue').addEventListener('change', function () {
            let checked_ = document.getElementById('shuxue').checked;
            let cfg = JSON.parse(localStorage.getItem('post_data'));
            cfg.ps = checked_;
            localStorage.setItem('post_data', JSON.stringify(cfg));
        });
        document.getElementById('tubiao').addEventListener('change', function () {
            let checked_ = document.getElementById('tubiao').checked;
            let cfg = JSON.parse(localStorage.getItem('post_data'));
            cfg.ptb = checked_;
            localStorage.setItem('post_data', JSON.stringify(cfg));
        });





















    });


</script>


<script>
    const { Editor } = toastui;
    const { codeSyntaxHighlight } = Editor.plugin;
    const { colorSyntax } = Editor.plugin;

    const autosave_btn = document.createElement('div');
    autosave_btn.className = 'form-check form-switch m-0 p-0 d-flex align-items-center justify-content-center';
    autosave_btn.style = 'width:100px';

    const autosave_input = document.createElement('input');
    autosave_input.className = 'form-check-input m-0';
    autosave_input.type = 'checkbox';
    autosave_input.role = 'switch';
    autosave_input.id = 'auto_save';
    autosave_input.checked = false;

    //自动保存文章
    var intervalId = null; // 在函数外部定义intervalId
    function checkAutoSaveStatus() {
        var cfg = get_config();
        if (autosave_input.checked) {
            if (intervalId === null) { // 确保不会重复设置定时器
                // console.log("自动保存已开启");   
                cfg.zdbc = true;

                let pt = document.getElementById("post_title").value;
                let pd = document.getElementById("post_description").value;
                let pc = document.getElementById("post_categories").value;
                let ptag = document.getElementById("post_tag").value;
                let pi = document.getElementById("post_img").value;
                let pia = document.getElementById("post_img_alt").value;
                let pz = document.getElementById("zhiding").checked;
                let ps = document.getElementById("shuxue").checked;
                let ptb = document.getElementById("tubiao").checked;

                let post_data = {
                    "pt": pt,
                    "pd": pd,
                    "pc": pc,
                    "ptag": ptag,
                    "pi": pi,
                    "pia": pia,
                    "pz": pz,
                    "ps": ps,
                    "ptb": ptb
                }

                localStorage.setItem('post_data', JSON.stringify(post_data));
                localStorage.setItem('contents', JSON.stringify(editor.getMarkdown()));
                intervalId = setInterval(function () {
                    localStorage.setItem('post_data', JSON.stringify(post_data));
                    localStorage.setItem('contents', JSON.stringify(editor.getMarkdown()));
                    // console.log(editor.getMarkdown());
                }, 120000);
            }
        } else {
            clearInterval(intervalId); // 关闭自动保存时清除定时器
            intervalId = null; // 重置intervalId
            localStorage.removeItem('contents');
            localStorage.removeItem('post_data');
            cfg.zdbc = false;
        }
        set_config(cfg);
    }
    // 添加事件监听器以在checkbox状态改变时调用checkAutoSaveStatus
    autosave_input.addEventListener('change', checkAutoSaveStatus);



    const autosave_label = document.createElement('label');
    autosave_label.className = 'form-check-label ms-1';
    autosave_label.htmlFor = 'auto_save';
    autosave_label.textContent = '自动保存';
    autosave_label.style = 'font-size: 0.8rem;'


    autosave_btn.appendChild(autosave_input);
    autosave_btn.appendChild(autosave_label);

    const tuchuang_switch = document.getElementById("tuchuang");



    const editor = new Editor({
        el: document.querySelector('#editor'),
        initialEditType: 'markdown',
        previewStyle: 'tab',
        height: '100%',
        language: 'zh-CN',
        toolbarItems: [
            ['heading', 'bold', 'italic', 'strike'],
            ['hr', 'quote'],
            // ['ul', 'ol', 'task', 'indent', 'outdent'],
            ['ul', 'ol', 'task',],
            ['table', 'image', 'link'],
            ['code', 'codeblock'],
            ['scrollSync'],
            [{
                name: 'as',
                tooltip: '自动保存',
                className: 'toastui-editor-toolbar-icons',
                el: autosave_btn,
                style: { backgroundImage: '' }
            }],
        ],
        plugins: [codeSyntaxHighlight, colorSyntax],
        theme: '', //dark

    });

    const alertPlaceholder = document.getElementById('liveAlertPlaceholder')

    // 蓝色：primary  白灰色：secondary  绿色：success  红色：danger  黄色：warning  天蓝色：info 白色：light  黑色：dark
    const alert = (message, type) => {
        const wrapper = document.createElement('div')
        wrapper.innerHTML = [
            `<div class="alert alert-${type} alert-dismissible text-center show fade" role="alert" >`,
            `   <div>${message}</div>`,
            '   <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close" ></button>',
            '</div>'
        ].join('')

        alertPlaceholder.append(wrapper)
    }




</script>


</html>
